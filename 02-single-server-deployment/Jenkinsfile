pipeline {
    agent any

    environment {
        SERVER_IP = credentials('prod-vm-ip')  
        PASSWORD = credentials('password')  
    }

    stages {
        stage('Checkout') {
            steps {
                // Checkout the Git repository to ensure requirements.txt is available
                checkout scm

                // Debugging step to list the contents of the repository and check if requirements.txt exists
                sh 'ls -lart'
            }
        }

        stage('Setup Virtual Environment') {
            steps {
                script {
                    // Ensure that we create and activate a virtual environment before installing dependencies
                    sh '''
                    python3 -m venv venv
                    bash -c "source venv/bin/activate && ls -lart && pip install -r requirements.txt"
                    '''
                }
            }
        }

        stage('Test') {
            steps {
                // Run tests (you may adjust this as per your test framework)
                script {
                    sh '''
                    bash -c "source venv/bin/activate && pytest"
                    '''
                }
            }
        }

        stage('Package Code') {
            steps {
                // Create a zip of the project excluding the .git directory
                script {
                    sh '''
                    zip -r myapp.zip ./* -x '*.git*'
                    ls -lart
                    '''
                }
            }
        }

        stage('Deploy to Prod') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'prod-credentials', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                    script {
                        // Use sshpass to connect via password authentication
                        sh '''
                        # Copy the app.zip file to the remote server
                        sshpass -p $PASSWORD scp -o StrictHostKeyChecking=no myapp.zip $USERNAME@$SERVER_IP:/home/$USERNAME/

                        # SSH into the server and deploy the app
                        sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $USERNAME@$SERVER_IP << EOF
                            # Unzip the application
                            unzip -o /home/$USERNAME/myapp.zip -d /home/$USERNAME/app/

                            # Set up virtual environment and install dependencies
                            cd /home/$USERNAME/app/
                            python3 -m venv venv
                            bash -c "source venv/bin/activate && ls -lart && pip install -r requirements.txt"

                            # Restart the service
                            sudo systemctl restart flaskapp.service
                        EOF
                        '''
                    }
                }
            }
        }
    }
}
