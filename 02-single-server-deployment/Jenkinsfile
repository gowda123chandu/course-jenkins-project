pipeline {
    agent any

    environment {
        SERVER_IP = credentials('prod-vm-ip')  
        PASSWORD = credentials('password')  
    }

    stages {
        stage('Setup') {
            steps {
                // Install dependencies in virtual environment
                script {
                    sh """
                    # Print the current working directory
                    pwd
                    # List files in the directory to check if requirements.txt is there
                    ls -l
                    # Install dependencies in the virtual environment
                    python3 -m venv venv
                    bash -c 'source venv/bin/activate && pip install -r requirements.txt'
                    """
                }
            }
        }

        stage('Test') {
            steps {
                // Run tests (you may adjust this as per your test framework)
                script {
                    sh """
                    bash -c 'source venv/bin/activate && pytest'
                    """
                }
            }
        }

        stage('Package Code') {
            steps {
                // Create a zip of the project excluding the .git directory
                script {
                    sh """
                    # List files to check if requirements.txt exists before zipping
                    ls -l
                    zip -r myapp.zip ./* -x '*.git*'
                    # Verify if requirements.txt is in the zip file
                    unzip -l myapp.zip
                    ls -lart
                    """
                }
            }
        }

        stage('Deploy to Prod') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'prod-credentials', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                    script {
                        // Use sshpass to connect via password authentication
                        sh """
                        # Copy the app.zip file to the remote server
                        sshpass -p \$PASSWORD scp -o StrictHostKeyChecking=no myapp.zip \$USERNAME@\$SERVER_IP:/home/\$USERNAME/

                        # SSH into the server and deploy the app
                        sshpass -p \$PASSWORD ssh -o StrictHostKeyChecking=no \$USERNAME@\$SERVER_IP << EOF
                            # Unzip the application
                            unzip -o /home/\$USERNAME/myapp.zip -d /home/\$USERNAME/app/

                            # Print the current working directory to verify location
                            cd /home/\$USERNAME/app/
                            pwd

                            # List files in the directory to check if requirements.txt is there
                            ls -l

                            # Set up virtual environment and install dependencies
                            python3 -m venv venv
                            bash -c 'source venv/bin/activate && pip install -r requirements.txt'

                            # Restart the service
                            sudo systemctl restart flaskapp.service
                        EOF
                        """
                    }
                }
            }
        }
    }
}
