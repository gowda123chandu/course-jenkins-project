pipeline {
    agent any
    environment {
        SERVER_IP = '52.172.157.148'
        SHELL = '/bin/bash'  
    }
    stages {
        stage('Deploy to Prod') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'password', passwordVariable: 'password', usernameVariable: 'SSH_USER')]) {
                    sh '''
                    # Copy the app to the server
                    sshpass -p $SSH_PASSWORD scp -o StrictHostKeyChecking=no myapp.zip ${SSH_USER}@${52.172.157.148}:/home/azureuser/
                    
                    # SSH into the server and deploy
                    sshpass -p $SSH_PASSWORD ssh -o StrictHostKeyChecking=no ${SSH_USER}@${52.172.157.148} << EOF
                        # Unzip the app
                        unzip -o /home/azureuser/myapp.zip -d /home/azureuser/app/

                        # Install python3-venv if not already installed
                        sudo apt-get install python3-venv

                        # Create and activate the virtual environment
                        python3 -m venv /home/azureuser/app/venv
                        source /home/ec2-user/app/venv/bin/activate

                        # Install dependencies
                        pip install -r /home/azureuser/app/requirements.txt

                        # Restart the flask app
                        sudo systemctl restart flaskapp.service
EOF
                    '''
                }
            }
        }
    }
}